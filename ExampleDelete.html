<script id="colMatFrag" type="shader">
    varying vec2 vUv;
    uniform sampler2D image;
    uniform float rad;
    
    void main() {
        vec3 texture = texture2D (image, vUv ).rgb;
        vec2 uv = vUv.xy;
        float var_R = texture[0];
        float var_G = texture[1]; 
        float var_B = texture[2];
    
        if (var_R > 0.04045) var_R = pow(((var_R + 0.055) / 1.055), 2.4);
        else var_R = var_R / 12.92;
        if (var_G > 0.04045) var_G = pow(((var_G + 0.055) / 1.055), 2.4);
        else var_G = var_G / 12.92;
        if (var_B > 0.04045) var_B = pow(((var_B + 0.055) / 1.055), 2.4);
        else var_B = var_B / 12.92;
    
        var_R *= 100.0;
        var_G *= 100.0;
        var_B *= 100.0;
    
        float XYZ[3];
    
        XYZ[0] = (var_R * 0.4124 + var_G * 0.3576 + var_B * 0.1805) / 95.047;
        XYZ[1] = (var_R * 0.2126 + var_G * 0.7152 + var_B * 0.0722) / 100.0;
        XYZ[2] = (var_R * 0.0193 + var_G * 0.1192 + var_B * 0.9505) / 108.883;
    
        for (int i = 0; i < 3; ++i) {
            float value = XYZ[i];
            if (value > 0.008856) {
                value = pow(value, 0.3333333333333333);
            } else {
                value = (7.787 * value) + float(16 / 116);
            }
            XYZ[i] = value;
        }
    
        float L = (116.0 * XYZ[1]) - 16.0;
        float a = 500.0 * (XYZ[0] - XYZ[1]);
        float b = 200.0 * (XYZ[1] - XYZ[2]);
    
        float C = sqrt((a * a) + (b * b));
        float hub = atan(b / a);
    
        float na = cos(hub + rad) * C;
        float nb = sin(hub + rad) * C;
    
        float nY = (L + 16.0) / 116.0;
        float nX = (na / 500.0) + nY;
        float nZ = nY - (nb / 200.0);
    
        if (pow(nY, 3.0) > 0.008856) nY = pow(nY, 3.0);
        else                       nY = (nY - (16.0 / 116.0)) / 7.787;
        if (pow(nX, 3.0) > 0.008856) nX = pow(nX, 3.0);
        else                       nX = (nX - (16.0 / 116.0)) / 7.787;
        if (pow(nZ, 3.0) > 0.008856) nZ = pow(nZ, 3.0);
        else                       nZ = (nZ - (16.0 / 116.0)) / 7.787;
    
        nX *= 95.047;
        nY *= 100.0;
        nZ *= 108.883;
    
        float nR = (nX / 100.0) * 3.2406 + (nY / 100.0) * -1.5372 + (nZ / 100.0) * -0.4986;
        float nG = (nX / 100.0) * -0.9689 + (nY / 100.0) * 1.8758 + (nZ / 100.0) * 0.0415;
        float nB = (nX / 100.0) * 0.0557 + (nY / 100.0) * -0.2040 + (nZ / 100.0) * 1.0570;
    
        if (nR > 0.0031308) nR = 1.055 * (pow(nR, (1.0 / 2.4))) - 0.055;
        else                nR = 12.92 * nR;
        if (nG > 0.0031308) nG = 1.055 * (pow(nG, (1.0 / 2.4))) - 0.055;
        else                nG = 12.92 * nG;
        if (nB > 0.0031308) nB = 1.055 * (pow(nB, (1.0 / 2.4))) - 0.055;
        else                nB = 12.92 * nB;
    
        vec3 res = vec3 ( nR, nG, nB);
        gl_FragColor.rgb = res;    
        gl_FragColor.a = 1.0;
    }
    </script>